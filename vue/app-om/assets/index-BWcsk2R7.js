import{d as X,g as G,r as H,o as b,c as F,a as l,a2 as ne,u as n,w as _,f as s,k as ee,z as K,e as N,t as q,h as Y,i as L,l as Q,Y as ie,aF as re,a4 as B,a6 as ce,b as de,aa as pe,a8 as _e,F as ue,p as me,y as fe,cD as ge,E as be,a9 as he,a3 as W}from"./index-ClTGGYJq.js";import{v as te}from"./el-loading-WYLhAgbb.js";import{_ as ae}from"./ViewFiles-BGc_2hC6.js";/* empty css                        *//* empty css                    */import{a as oe,E as se}from"./index-G0MRvna3.js";import{_ as we}from"./Problems-BQla5dLf.js";/* empty css                    *//* empty css                   */import{E as ye}from"./index-BewEhLyo.js";import{E as Z}from"./index-DIHLlVQH.js";import{_ as ve}from"./AaTitle.vue_vue_type_script_setup_true_lang-DQZ6AruM.js";import{_ as ke}from"./filter-CPm302q-.js";import"./index-CcHJUmzw.js";const $e={class:"topclass"},xe={class:"ww100 h100x6 flex-col hidden"},Fe={class:"layout-col white-rgba50 rad8 p15"},Ce=["onClick"],Ne={key:1},Se=["onClick"],Ae={key:1},Ve=X({__name:"ProblemLog",props:{state:{type:[Object,Array],default:()=>({})}},setup(I,{expose:m}){const{proxy:g}=G(),S=g.publicStore();g.configStore();let A=L();const i=H({...S.$state,status:""}),T=v=>parseInt(i.page)+v,E=async v=>{i.isFalse=!i.isFalse,i.isFalse&&(i.active={...v},t())},t=async v=>{let C={model:"t_scheme_problem_log",args:`scheme_id='${i.active.scheme_id}' and parent_id='${i.active.parent_id}'`};i.status!==""&&i.status!=null&&(C.args+=` and problem_status='${i.status}'`);let c={limit:i.limit,page:i.page},u={field:"COUNT(*)"},k={},f={};Object.assign(k,C,c),Object.assign(f,C,u);let $=await S.http({Api1:k,Api2:f});i.empty=!!g.isNull($.Api1),i.list=g.isNull($.Api1)?[]:$.Api1,i.total=g.isNull($.Api2)?0:$.Api2[0]["COUNT(*)"]};return m({onVisable:E}),(v,C)=>{const c=se,u=oe,k=ae,f=ne,$=te;return b(),F("div",$e,[l(f,{"modal-class":"topclass",modelValue:n(i).isFalse,"onUpdate:modelValue":C[0]||(C[0]=x=>n(i).isFalse=x),title:"整改进度更新","before-close":E,draggable:!0,width:"62%"},{default:_(()=>[s("div",xe,[s("div",Fe,[v.isNull(n(i).list)?Y("",!0):ee((b(),K(u,{key:0,"header-cell-class-name":"bgi16 c3","cell-style":{"background-color":"#FFFFFF",color:"#626366"},border:"","empty-text":"暂无数据",data:n(i).list,stripe:""},{default:_(()=>[l(c,{type:"index",index:T,label:"序号",align:"center",width:"50"}),l(c,{prop:"msg",label:"修改内容"}),l(c,{prop:"action_rate",label:"原进度",width:"100",align:"center"}),l(c,{prop:"new_action_rate",label:"新进度",width:"100",align:"center"}),l(c,{label:"原支撑材料",align:"center",width:"100"},{default:_((x,j)=>[x.row.action_material?(b(),F("span",{key:0,class:"i1 cursor",onClick:N(J=>n(A).onVisable(x.row.action_material),["stop"])},"查看",8,Ce)):(b(),F("span",Ne,"无"))]),_:1}),l(c,{label:"新支撑材料",align:"center",width:"100"},{default:_((x,j)=>[x.row.new_action_material?(b(),F("span",{key:0,class:"i1 cursor",onClick:N(J=>n(A).onVisable(x.row.new_action_material),["stop"])},"查看",8,Se)):(b(),F("span",Ae,"无"))]),_:1}),l(c,{label:"更新时间",align:"center",width:"150"},{default:_((x,j)=>[s("span",null,q(v.parseTime(x.row.update_time)),1)]),_:1})]),_:1},8,["data"])),[[$,n(i).loading,void 0,{fullscreen:!0,lock:!0}]])])]),l(k,{ref_key:"viewRef",ref:A},null,512)]),_:1},8,["modelValue"])])}}}),Ee=Q(Ve,[["__scopeId","data-v-a0a5e390"]]),Oe={key:0},Te={key:1},Pe=X({__name:"UploadTextNoName",props:re({action:{type:String,default:"/api/v1/terminal/base/uploadFile"},fileLimit:{type:Number,default:5},fileSize:{type:Number,default:50},fileType:{type:Array,default:[]},fileList:{type:[Array,String],default:[]}},{model:{},modelModifiers:{}}),emits:["update:model"],setup(I){const{proxy:m}=G();m.publicStore();const g=m.configStore(),S=ie(I,"model"),A=I,i=H({dialogVisible:!1,dialogImageUrl:""}),T=c=>{i.dialogImageUrl=c.url,i.dialogVisible=!0},E=c=>{const u=c.size/1024/1024<A.fileSize;return u||Z({type:"error",message:"上传图片大小不能超过 "+A.fileSize+"MB!"}),u},t=(c,u,k)=>{let f=u.response.data;f&&Object.prototype.hasOwnProperty.call(u,"response")&&u.response.data&&(S.value=f,B({title:"提示",message:u.status=="success"?"上传成功":"上传失败",type:u.status=="success"?"success":"error"}))},v=(c,u)=>{if(!c||!Object.prototype.hasOwnProperty.call(c,"response"))return;let k=c.response.data,f=S.value.findIndex($=>$==k);f!=-1&&S.value.splice(f,1)},C=()=>{i.loading=!1,Z({type:"error",message:"上传失败"})};return(c,u)=>{const k=ye;return b(),K(k,{class:"avatar-uploader","show-file-list":!1,action:I.action,headers:{Authorization:n(g).token,"X-CSRF-Token":n(g).csrfToken,AuthToken:"xyz"+c.encrypt("xyz"+n(g).secret_key)},"before-upload":E,"on-success":t,"on-error":C,"on-remove":v,"on-preview":T},{default:_(()=>[S.value?(b(),F("span",Oe,"已上传")):(b(),F("span",Te,"上传"))]),_:1},8,["action","headers"])}}}),Ue=Q(Pe,[["__scopeId","data-v-f57ee4de"]]),Me={class:"layout-col"},De={class:"flex-sc mr15"},qe={class:"w50x6 flex-sc"},Ie={class:"layout-col white-rgba50 rad8 p15"},Re={class:"ww100 flex-sc p8 mb15"},ze={class:"flex-sc fw f16 tc"},Be=["onClick"],je={class:"mb5"},Le={class:"layout-col"},Je={class:"problem-content f18 h50x8"},Ye={class:"hh100 overlay flex-col"},Xe={class:"line2"},Ge=["onClick"],He=["onClick"],Ke={class:"ww100 flex-cc"},Qe=["onClick"],We=X({__name:"index",setup(I){const{proxy:m}=G(),g=m.publicStore();m.configStore();const S=ce(),A=[{value:"1",name:"限时整改",color:"i5"},{value:"2",name:"尽力整改",color:"i11"}];let i=L(),T=L(),E=L();const t=H({...g.$state}),v=o=>parseInt(t.page)+o,C=({row:o,column:e,rowIndex:p,columnIndex:r})=>{if(r===1||r===2)return p%2===0?{rowspan:2,colspan:1}:{rowspan:0,colspan:0}},c=({column:o})=>o.label==="整改进度"||o.label==="支撑材料上传"?{"background-color":"#FFFFFF",color:"#626366"}:{"background-color":"#F5F5F5",color:"#626366"};de(async()=>{t.active={...S.query},await k(),f()});const u=o=>{const e=o.action_material;i.value.onVisable(e)},k=async()=>{let o={model:"t_task_type",args:`parent_id='${t.active.parent_id}'`,order:"orderd ASC"},e=await g.http({Api:o});t.actives=m.isNull(e)?[]:e.sort((p,r)=>p.orderd-r.orderd)},f=async o=>{let e={model:"t_task_problem",args:`parent_id='${t.active.id}'`,order:"orderd ASC"},p={model:"t_scheme_problem",args:`scheme_id='${t.active.scheme_id}' and parents_id='${t.active.id}'`};if(!m.isNull(t.datetime)){const[y,d]=t.datetime,h=new Date(y.getFullYear(),0,1).getTime()+"",R=new Date(d.getFullYear(),11,31,23,59,59,999).getTime()+"";p.args+=` and check_time>='${h}' and check_time<='${R}'`}let r=await g.http({Api1:e,Api2:p});t.task_problems=m.isNull(r.Api1)?[]:r.Api1,t.list=m.isNull(r.Api2)?[]:JSON.parse(JSON.stringify(r.Api2)),t.oldlist=m.isNull(r.Api2)?[]:JSON.parse(JSON.stringify(r.Api2))},$=async()=>{he.confirm("是否确定保存?","温馨提示",{confirmButtonText:"确定",cancelButtonText:"关闭",type:"success"}).then(()=>{let o=J();if(console.log("params",o),m.isNull(o))return B({title:"提示",message:"无数据改变",type:"info"});let{forms:e,changeFile:p,logs:r}=le(o),y={model:"t_scheme_problem",list:e};W.updApi(y).then(d=>{d.code==200?(B({title:"提示",message:"操作成功",type:"success"}),f(),x(p),j(r)):B({title:"提示",message:d.msg?d.msg:"操作失败400",type:"error"})}).catch(d=>{B({title:"提示",message:"操作失败401",type:"error"})})})},x=async o=>{if(m.isNull(o))return console.log("无需转移");let e={list:o};g.http({changeFileApi:e}).then(p=>{console.log("转移res",p)})},j=async o=>{if(m.isNull(o))return;let e={model:"t_scheme_problem_log",list:o};W.addApi(e).then(p=>{}).catch(p=>{})},J=()=>t.list.map((e,p)=>{const r=t.oldlist[p];if(!r)return null;const y=[];return e.action_rate!==r.action_rate&&y.push(`整改进度从原来${r.action_rate||"空"}到${e.action_rate||"空"}`),e.action_material!==r.action_material&&y.push("支撑材料已改变"),y.length===0?null:{id:e.id,scheme_id:t.active.scheme_id,parent_id:t.active.id,msg:y.join("，"),action_rate:r.action_rate,new_action_rate:e.action_rate,action_material:r.action_material,new_action_material:e.action_material,update_time:Date.now()+""}}).filter(Boolean),le=o=>{const e=[],p=[],r=[],y="static/problems",d=Date.now()+"";return o.forEach((h,R)=>{const P=h.action_rate,z=h.action_material;let U=P,M=z;const D=[];h.new_action_rate!=null&&h.new_action_rate!==P&&(U=h.new_action_rate,D.push(`整改进度从原来${P||"空"}到${U||"空"}`));const V=h.new_action_material;if(V!=null&&V!==z){if(V.includes("/uploads")){const a="."+V.split(".").pop(),w=`${y}/${h.id}_${d}_${R}${a}`;r.push({oldfile:V,newfile:w}),M=w}else M=V;D.push("支撑材料已改变")}if(e.push({id:h.id,action_rate:U,action_material:M}),D.length>0){const{id:a,...w}=h;p.push({...w,msg:D.join("，"),action_rate:P,new_action_rate:U,action_material:z,new_action_material:M,update_time:d})}}),{forms:e,logs:p,changeFile:r}};return(o,e)=>{const p=_e,r=ke,y=ve,d=se,h=ge,R=be,P=Ue,z=oe,U=we,M=Ee,D=ae,V=te;return b(),F("div",Me,[l(y,{title:""},{"left-content":_(()=>[s("div",De,[e[5]||(e[5]=s("span",{class:"mr10"},"体检年度",-1)),s("span",qe,[l(p,{class:"",style:{width:"100%"},modelValue:n(t).datetime,"onUpdate:modelValue":e[0]||(e[0]=a=>n(t).datetime=a),type:"yearrange","range-separator":"-","start-placeholder":"请选择年度","end-placeholder":"请选择年度"},null,8,["modelValue"])])]),s("div",{class:"rad4 ptb6 plr12 flex-cc cursor bgi1 white",onClick:e[1]||(e[1]=N(a=>f(),["stop"]))},[l(r,{class:"f12 fw"}),e[6]||(e[6]=s("span",{class:"f14 ml5"},"搜索",-1))])]),"right-content":_(()=>[s("div",{class:"rad4 ptb6 plr12 flex-cc cursor bo-i1-1 i1 ml15",onClick:e[2]||(e[2]=N(a=>n(E).onVisable({scheme_id:n(t).active.scheme_id,parent_id:n(t).active.id}),["stop"]))},[...e[7]||(e[7]=[s("span",{class:"f14 ml5"},"查看更新记录",-1)])]),s("div",{class:"rad4 ptb6 plr12 flex-cc cursor bo-i1-1 i1 ml15",onClick:e[3]||(e[3]=N(a=>$(),["stop"]))},[...e[8]||(e[8]=[s("span",{class:"f14 ml5"},"保存",-1)])]),s("div",{class:"rad4 ptb6 plr12 flex-cc cursor bo-i1-1 i1 ml15",onClick:e[4]||(e[4]=N(a=>n(pe).back(),["stop"]))},[...e[9]||(e[9]=[s("span",{class:"f14 ml5"},"返回",-1)])])]),_:1}),s("div",Ie,[s("div",Re,[s("div",ze,[(b(!0),F(ue,null,me(n(t).actives?n(t).actives:[],(a,w)=>(b(),F("div",{class:"mr20 cursor flex-col-cc",key:w,onClick:N(O=>{n(t).active.id=a.id,n(t).page=1,f()},["stop"])},[s("span",je,q(a.name),1),s("span",{class:fe(["ww100 h3 rad10",a.id==n(t).active.id?"bgi2":"black-rgba0"])},null,2)],8,Be))),128))])]),s("div",Le,[o.isNull(n(t).list)?Y("",!0):ee((b(),K(z,{key:0,"header-cell-class-name":"bgi16 c3","cell-style":c,"span-method":C,border:"","empty-text":"暂无数据",data:n(t).list,stripe:""},{default:_(()=>[l(d,{type:"index",index:v,label:"序号",align:"center",width:"50"}),l(d,{label:"指标项",width:"250"},{default:_((a,w)=>[s("span",null,q(a.row.parent_id?o.find(n(t).task_problems,["id",a.row.parent_id],"name"):""),1)]),_:1}),l(d,{prop:"result",label:"体检结果",align:"center",width:"80"}),l(d,{label:"存在问题"},{default:_((a,w)=>[l(h,{title:"",width:"800",placement:"top-start"},{default:_(()=>[s("div",Je,[s("div",Ye,q(a.row.problem_content),1)])]),reference:_(()=>[s("span",Xe,q(a.row.problem_content),1)]),_:2},1024)]),_:1}),l(d,{label:"整治类型",align:"center",width:"80"},{default:_((a,w)=>[s("span",null,q(a.row.action_type?o.find(A,["value",a.row.action_type],"name"):""),1)]),_:1}),l(d,{prop:"problem_num",label:"问题数量",width:"80",align:"center"}),l(d,{label:"整改进度",width:"100",align:"center"},{default:_((a,w)=>[l(R,{class:"i1 cursor progress-input",modelValue:a.row.action_rate,"onUpdate:modelValue":O=>a.row.action_rate=O,modelModifiers:{number:!0},placeholder:"请输入进度",type:"number",min:"0",max:"100",controls:!1,oninput:"if(value>100)value=100;if(value<0)value=0;if(value.indexOf('.')>=0)value=value.slice(0,value.indexOf('.')+3)"},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),l(d,{label:"问题区域",align:"center",width:"100"},{default:_((a,w)=>[s("span",{class:"i1 cursor",onClick:N(O=>n(T).onVisable(a.row),["stop"])},"查看问题分布",8,Ge)]),_:1}),l(d,{label:"整改项目清单",align:"center",width:"100"},{default:_((a,w)=>[s("span",{class:"i1 cursor",onClick:N(O=>o.toPath("/schemePlansManagerCity",{id:a.row.id}),["stop"])},"查看项目清单",8,He)]),_:1}),l(d,{label:"支撑材料上传",width:"100",align:"center"},{default:_((a,w)=>[s("span",Ke,[l(P,{model:a.row.action_material,"onUpdate:model":O=>a.row.action_material=O},null,8,["model","onUpdate:model"]),a.row.action_material?(b(),F("span",{key:0,class:"i1 cursor ml10",onClick:N(O=>u(a.row),["stop"])},"查看",8,Qe)):Y("",!0)])]),_:1})]),_:1},8,["data"])),[[V,n(t).loading,void 0,{fullscreen:!0,lock:!0}]])])]),l(U,{state:n(t),ref_key:"problemRef",ref:T},null,8,["state"]),l(M,{state:n(t),ref_key:"problemlogRef",ref:E},null,8,["state"]),l(D,{ref_key:"viewRef",ref:i},null,512)])}}}),ut=Q(We,[["__scopeId","data-v-9fdfcc23"]]);export{ut as default};
