import{d as F,g as Y,r as B,o as S,c as C,f as g,a as s,Z as D,u as r,w as d,e as V,i as O,$ as I,E as J,a8 as j,z,h as M,a9 as U,a3 as T,a4 as b,aa as q,l as L}from"./index-Bd85TTIS.js";import{_ as R}from"./FileList.vue_vue_type_script_setup_true_lang-CKvp74Rm.js";import{a as h}from"./areaData-CfkeTXdx.js";import{v as k}from"./v6-B4YtUg27.js";import"./ViewFiles-DMp3eGxU.js";import"./UploadText-D3EldgGp.js";/* empty css                    *//* empty css                   */import"./index-DXutnob0.js";import"./index-DDNRsVXm.js";/* empty css                                                                   */const P={class:"layout-col overlay"},X={class:"hh100 ww100 flex-sc warp"},Z={class:"flex-sc warp ww100"},G={class:"ww100 flex-cc f18 p40 bot-i16-1 mt20"},H=F({__name:"step2",props:{state:{type:[Object,Array],default:()=>({})},contents:{type:Array,default:[]},active:{type:[Object,Array],default:()=>({})}},setup($){const{proxy:n}=Y(),a=n.publicStore(),w=n.configStore();n.dictStore();let v=O(),E=O({});B({...a.$state});const x=$,A=u=>{u.validate(async l=>{l&&(console.log("publicStore.form---2",a.form),U.confirm("否确定操作继续","温馨提示",{confirmButtonText:"确定",cancelButtonText:"关闭",type:"warn"}).then(async()=>{let e=JSON.parse(JSON.stringify(a.form)),p=Date.now()+"";e.type="report",e.update_time=p,e.user_id=w.user.id,e.user_name=w.user.name;let _=e.id?"updApi":"addApi";if(_=="updApi")e.apply_status="1",e.apply_time=p;else{const t=new Date().toISOString().slice(0,10).replace(/-/g,"");e.num_title="SX",e.num_date=t;let i={model:"t_project_report",args:`num_title='${e.num_title}' and num_date='${e.num_date}'`,field:"num_number",order:"num_number asc"},c=await a.http({Api:i});e.num_number=n.isNull(c)?"000001":String(parseInt(c[0].num_number,10)+1).padStart(6,"0")}if(e.id||(e.id=k()),!n.isNull(e.area)){if(e.area.length>0){e.province=e.area.length>0?e.area[0]:"";let t=n.findNode(h,i=>i.code==e.province);t&&(e.province_name=t.name)}if(e.area.length>1){e.city=e.area.length>1?e.area[1]:"";let t=n.findNode(h,i=>i.code==e.city);t&&(e.city_name=t.name)}if(e.area.length>2){e.district=e.area.length>2?e.area[2]:"";let t=n.findNode(h,i=>i.code==e.district);t&&(e.district_name=t.name)}e.area=JSON.stringify(e.area)}e.fund_source=n.isNull(e.fund_source)?"":JSON.stringify(e.fund_source),e.orther_text=n.isNull(e.orther_text)?"":JSON.stringify(e.orther_text);let m=[];n.isNull(e.attr)?e.attr="":(Object.keys(e.attr).forEach(t=>{if(e.attr[t].data&&e.attr[t].data.indexOf("/uploads")!=-1){const c=`${a._public.contents1.find(y=>y.type==t).parent_type}/${w.user.id}_${t}_${e.attr[t].name}`;e.attr[t].data=c,m.push({oldfile:a.form.attr[t].data,newfile:c})}}),e.attr=JSON.stringify(e.attr));let f=[];n.isNull(e.plan_attr)?e.plan_attr="":(Object.keys(e.plan_attr).forEach(t=>{if(e.plan_attr[t].data&&e.plan_attr[t].data.indexOf("/uploads")!=-1){const c=`${a._public.contents2.find(y=>y.type==t).parent_type}/${w.user.id}_${t}_${e.plan_attr[t].name}`;e.plan_attr[t].data=c,f.push({oldfile:a.form.plan_attr[t].data,newfile:c})}}),e.plan_attr=JSON.stringify(e.plan_attr));let o={model:"t_project_report",list:[e]};console.log("params",o),console.log("changeFile1",m),console.log("changeFile2",f),T[_](o).then(async t=>{if(t.code==200){let i=_=="updApi"?"申请成功":"保存成功";b({title:"提示",message:i,type:"success"}),n.isNull(m)||N(m),n.isNull(f)||N(f),setTimeout(()=>{q.back()},500)}else b({title:"提示",message:t.msg?t.msg:"保存失败(400)",type:"error"})}).catch(t=>{b({title:"提示",message:"保存失败(500)",type:"error"})})}))})},N=async u=>{if(n.isNull(u))return console.log("无需转移");let l={list:u};a.http({changeFileApi:l}).then(e=>{console.log("转移基础文件res",e)})};return(u,l)=>{const e=J,p=I,_=j,m=R,f=D;return S(),C("div",P,[g("div",X,[s(f,{class:"ww100 pplr15",ref_key:"formRef",ref:v,model:r(a).form,rules:r(E),"label-width":"120"},{default:d(()=>[g("div",Z,[s(p,{label:"方案名称",prop:"plan_name",class:"ww50 flex-sc"},{default:d(()=>[s(e,{size:"large",modelValue:r(a).form.plan_name,"onUpdate:modelValue":l[0]||(l[0]=o=>r(a).form.plan_name=o),placeholder:"请输入"},null,8,["modelValue"])]),_:1}),s(p,{label:"方案编制单位",prop:"plan_unit",class:"ww50 flex-sc"},{default:d(()=>[s(e,{size:"large",modelValue:r(a).form.plan_unit,"onUpdate:modelValue":l[1]||(l[1]=o=>r(a).form.plan_unit=o),placeholder:"请输入"},null,8,["modelValue"])]),_:1}),s(p,{label:"复批时间",prop:"approval_time",class:"ww50 flex-sc"},{default:d(()=>[s(_,{modelValue:r(a).form.approval_time,"onUpdate:modelValue":l[2]||(l[2]=o=>r(a).form.approval_time=o),style:{width:"100%"},size:"large",type:"datetime",placeholder:"请选择",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD"},null,8,["modelValue"])]),_:1}),s(p,{label:"方案摘要",prop:"plan_abstract",class:"ww100 flex-sc"},{default:d(()=>[s(e,{size:"large",modelValue:r(a).form.plan_abstract,"onUpdate:modelValue":l[3]||(l[3]=o=>r(a).form.plan_abstract=o),type:"textarea",rows:4,placeholder:"请输入"},null,8,["modelValue"])]),_:1}),s(p,{label:"基础建设条件",prop:"condition",class:"ww100 flex-sc"},{default:d(()=>[s(e,{size:"large",modelValue:r(a).form.condition,"onUpdate:modelValue":l[4]||(l[4]=o=>r(a).form.condition=o),type:"textarea",rows:4,placeholder:"请输入"},null,8,["modelValue"])]),_:1}),s(p,{label:"实施方案文件上传",prop:"files",class:"ww100 flex-ss"},{default:d(()=>[r(a).form?.plan_attr?(S(),z(m,{key:0,files:r(a).form.plan_attr,"onUpdate:files":l[5]||(l[5]=o=>r(a).form.plan_attr=o),contents:x.contents,active:x.active},null,8,["files","contents","active"])):M("",!0)]),_:1})])]),_:1},8,["model","rules"]),g("div",G,[g("div",{class:"plr14 ptb5 rad4 ml15 cursor white bgi1 bo-i1-1",onClick:l[6]||(l[6]=V(o=>r(a).actIndex--,["stop"]))},"上一步"),g("div",{class:"plr14 ptb5 rad4 ml15 cursor white bgi1 bo-i1-1",onClick:l[7]||(l[7]=V(o=>A(r(v)),["stop"]))},"保 存")])])])}}}),ie=L(H,[["__scopeId","data-v-81bc8b17"]]);export{ie as default};
