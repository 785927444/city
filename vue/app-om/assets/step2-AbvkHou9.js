import{d as pe,g as ue,r as A,o as F,c as E,f as n,a as o,Z as me,u as r,w as u,e as f,y as Y,k as D,v as J,h as O,i as k,K,$ as _e,E as fe,a8 as ge,z as be,a7 as M,a9 as ve,a3 as S,a4 as N,aa as he,l as ye}from"./index-BF5jje68.js";import{E as we}from"./el-pagination-CLehCad4.js";/* empty css                        *//* empty css                    */import{_ as ke}from"./FileList.vue_vue_type_script_setup_true_lang-CjQZZdnb.js";import{a as R}from"./areaData-CfkeTXdx.js";import{E as Ve,a as xe}from"./index-fed1VsgQ.js";import{v as x}from"./v6-B4YtUg27.js";import"./ViewFiles-C92c8QO4.js";import"./question-filled-BgQjHn-S.js";/* empty css                    *//* empty css                   */import"./index-CU8Q0z-M.js";import"./index-CND7x1jx.js";/* empty css                                                                   */import"./index-VYQ43fvS.js";const Ce={class:"layout-col overlay"},Fe={class:"hh100 ww100 flex-sc warp"},Se={class:"flex-sc warp ww100"},Ne={class:"ww100 plr30 ptb22 bo-i16-1 rad8 bg-white"},Ue={class:"ww100 white-rgba50 rad8 p15 mt16"},Te={class:"ww100 flex-sc pb20 mt10"},$e={class:"layout-col white-rgba50 rad8 p15"},ze=["onClick"],Ie={class:"ww100 flex-cc mt10"},Ae={class:"ww100 flex-sb mt10"},Ee={class:"flex-sc"},Oe={class:"layout-col white-rgba50 rad8 p15"},Re={class:"ww100 flex-se mt10"},je={class:"ww100 flex-sb mt10"},Be={class:"flex-sc"},Ye={class:"ww100 white-rgba50 rad8 p15 mt16"},De={class:"layout-col white-rgba50 rad8 p15 mt10"},Je=["onClick"],Ke={class:"ww100 flex-cc f18 p40 bot-i16-1 mt20"},Me=pe({__name:"step2",props:{state:{type:[Object,Array],default:()=>({})},contents:{type:Array,default:[]},plans:{type:Array,default:[]},active:{type:[Object,Array],default:()=>({})}},setup(P){const{proxy:_}=ue(),d=_.publicStore(),V=_.configStore();_.dictStore();let j=k(),L=k({});A({...d.$state});const U=P,q=c=>{c.validate(async a=>{a&&(console.log("publicStore.form---2",d.form),ve.confirm("否确定操作继续","温馨提示",{confirmButtonText:"确定",cancelButtonText:"关闭",type:"warn"}).then(async()=>{let e=JSON.parse(JSON.stringify(d.form)),g=Date.now()+"";e.type="report",e.update_time=g,e.user_id=V.user.id,e.user_name=V.user.name;let w=e.id?"updApi":"addApi";if(w=="addApi"&&d.title=="apply"){const s=new Date().toISOString().slice(0,10).replace(/-/g,"");e.num_title="SX",e.num_date=s;let l={model:"t_project_report",args:`num_title='${e.num_title}' and num_date='${e.num_date}'`,field:"num_number",order:"num_number asc"},t=await d.http({Api:l});e.num_number=_.isNull(t)?"000001":String(parseInt(t[0].num_number,10)+1).padStart(6,"0")}if(w=="updApi"&&((e.apply_status="0")&&(e.apply_status="1",e.apply_time=g),e.apply_status="1"),e.id||(e.id=x()),!_.isNull(e.area)){if(e.area.length>0){e.province=e.area.length>0?e.area[0]:"";let s=_.findNode(R,l=>l.code==e.province);s&&(e.province_name=s.name)}if(e.area.length>1){e.city=e.area.length>1?e.area[1]:"";let s=_.findNode(R,l=>l.code==e.city);s&&(e.city_name=s.name)}if(e.area.length>2){e.district=e.area.length>2?e.area[2]:"";let s=_.findNode(R,l=>l.code==e.district);s&&(e.district_name=s.name)}e.area=JSON.stringify(e.area)}e.fund_source=_.isNull(e.fund_source)?"":JSON.stringify(e.fund_source),e.orther_text=_.isNull(e.orther_text)?"":JSON.stringify(e.orther_text);let b=[];_.isNull(e.attr)?e.attr="":(Object.keys(e.attr).forEach(s=>{if(e.attr[s].data&&e.attr[s].data.indexOf("/uploads")!=-1){const t=`${d._public.contents1.find(i=>i.type==s).parent_type}/${V.user.id}_${s}_${e.attr[s].name}`;e.attr[s].data=t,b.push({oldfile:d.form.attr[s].data,newfile:t})}}),e.attr=JSON.stringify(e.attr));let m=[];_.isNull(e.plan_attr)?e.plan_attr="":(Object.keys(e.plan_attr).forEach(s=>{if(e.plan_attr[s].data&&e.plan_attr[s].data.indexOf("/uploads")!=-1){const t=`${d._public.contents2.find(i=>i.type==s).parent_type}/${V.user.id}_${s}_${e.plan_attr[s].name}`;e.plan_attr[s].data=t,m.push({oldfile:d.form.plan_attr[s].data,newfile:t})}}),e.plan_attr=JSON.stringify(e.plan_attr));let p={model:"t_project_report",list:[e]};console.log("params",p),console.log("changeFile1",b),console.log("changeFile2",m),S[w](p).then(async s=>{if(s.code==200){let l=w=="updApi"?"申请成功":"保存成功";N({title:"提示",message:l,type:"success"}),_.isNull(b)||B(b),_.isNull(m)||B(m);const t=await X(s,e.id);await Z(e,t),setTimeout(()=>{he.back()},500)}else N({title:"提示",message:s.msg?s.msg:"保存失败(400)",type:"error"})}).catch(s=>{N({title:"提示",message:"保存失败(500)",type:"error"})})}))})},X=async(c,a)=>{let e=c?.data?.id;return!e&&c?.data?.list?.length&&(e=c.data.list[0]?.id),!e&&c?.data?.length&&(e=c.data[0]?.id),!e&&a&&(e=a),e},Z=async(c,a)=>{if(!c.scheme_id){console.warn("saveThreeTables: scheme_id is missing");return}const e=c.scheme_id,g=V.user.id,w=V.user.name,b={scheme_id:e,user_id:g,user_name:w,province:c.province,city:c.city,district:c.district,province_name:c.province_name,city_name:c.city_name,district_name:c.district_name},m={schemeTask:{add:[],upd:[],del:[]},projectTask:{add:[],upd:[],del:[]},problemResult:{add:[],upd:[],del:[]},problemItem:{add:[],upd:[],del:[]},problemLog:{add:[],upd:[],del:[]}},p=(l,t,i)=>{t.op==="delete"?t.id&&l.del.push({id:t.id}):t.id||t.op==="edit"?l.upd.push({...i,id:t.id}):l.add.push({...i,id:x()})};y.value&&y.value.length>0&&y.value.forEach(l=>{p(m.schemeTask,l,{...b,task_type:l.task_type,construct_content:l.construct_content,unit_target:l.construct_scale,scheme_name:c.plan_name||"",type:"1"}),a&&["t2026","t2027","t2028"].forEach(t=>{if(l[t]){const i=t.replace("t","");m.projectTask.add.push({id:x(),project_id:a,task_type:l.task_type,construct_content:l.construct_content,year:i,value:l[t]})}})}),h.value&&h.value.length>0&&h.value.forEach(l=>{const t=l.resultId||x(),i=l.itemId||x(),de=l.logId||x();p(m.problemResult,l,{...b,id:t,class:l.type,name:l.indicator}),p(m.problemItem,l,{...b,id:i,problem_id:t,problem_content:l.problem}),p(m.problemLog,l,{...b,id:de,parent_id:i,msg:l.content})}),C.value&&C.value.length>0&&a&&C.value.forEach(l=>{(l.desc||l.investment)&&p(m.projectTask,l,{id:l.id,project_id:a,year:l.year,construct_content:l.desc,value:l.investment})});const s=async(l,t)=>{try{t.add.length>0&&await S.addApi({model:l,list:t.add}),t.upd.length>0&&await S.updApi({model:l,list:t.upd}),t.del.length>0&&await S.delApi({model:l,list:t.del})}catch(i){console.error(`Failed to save ${l}`,i),N({title:"错误",message:`保存 ${l} 失败`,type:"error"})}};await s("t_scheme_task",m.schemeTask),await s("t_project_task",m.projectTask),await s("t_scheme_problem_result",m.problemResult),await s("t_scheme_problem_item",m.problemItem),await s("t_scheme_problem_log",m.problemLog)},B=async c=>{if(_.isNull(c))return console.log("无需转移");let a={list:c};d.http({changeFileApi:a}).then(e=>{console.log("转移基础文件res",e)})};let v=k("key");const T=A({page:2,limit:10,total:30}),$=A({page:2,limit:10,total:30}),h=k([{type:"危险性排查",indicator:"DR设备检定完成",problem:"部分设备未完成检定，影响年度达标",content:"整改10条"},{type:"危险性排查",indicator:"CB设备检定完成",problem:"检定记录缺失，需补录并复核",content:"整改10条"},{type:"危险性排查",indicator:"住宅隐患排查（车东米）",problem:"老旧小区隐患较多，需分批治理",content:"整改10条"}]),G=K(()=>h.value),y=k([{task_type:"危险性改造",construct_content:"DR设备检定改造（套）",construct_scale:"10",t2026:"10",t2027:""},{task_type:"危险性改造",construct_content:"CB设备检定改造（套）",construct_scale:"10",t2026:"10",t2027:""},{task_type:"民住改造",construct_content:"居住隐患改造（车东米）",construct_scale:"10",t2026:"10",t2027:""}]),H=K(()=>y.value);let z=k([]),I=k([]);const Q=c=>{z.value=c},W=c=>{I.value=c},ee=()=>{h.value.push({type:"危险性排查",indicator:"新增指标项",problem:"请填写问题描述",content:"整改"})},te=()=>{I.value=[...h.value]},le=()=>{h.value.splice(0,h.value.length,...h.value.filter(c=>!I.value.includes(c)))},ae=()=>{h.value.push({type:"危险性排查",indicator:"新增指标项",problem:"请填写问题描述",content:"整改"})},oe=c=>{},se=()=>{},ne=()=>{z.value=[...y.value]},ie=()=>{y.value.splice(0,y.value.length,...y.value.filter(c=>!z.value.includes(c)))},re=()=>{y.value.push({task_type:"新增任务类型",construct_content:"请输入建设内容",construct_scale:"",t2026:"",t2027:""})},C=k([{year:"2026",desc:"",investment:""},{year:"2027",desc:"",investment:""},{year:"2028",desc:"",investment:""}]),ce=c=>{};return(c,a)=>{const e=fe,g=_e,w=ge,b=ke,m=me,p=xe,s=Ve,l=we;return F(),E("div",Ce,[n("div",Fe,[o(m,{class:"ww100 pplr15",ref_key:"formRef",ref:j,model:r(d).form,rules:r(L),"label-width":"120"},{default:u(()=>[n("div",Se,[o(g,{label:"方案名称",prop:"plan_name",class:"ww50 flex-sc"},{default:u(()=>[o(e,{size:"large",modelValue:r(d).form.plan_name,"onUpdate:modelValue":a[0]||(a[0]=t=>r(d).form.plan_name=t),placeholder:"请输入"},null,8,["modelValue"])]),_:1}),o(g,{label:"方案编制单位",prop:"plan_unit",class:"ww50 flex-sc"},{default:u(()=>[o(e,{size:"large",modelValue:r(d).form.plan_unit,"onUpdate:modelValue":a[1]||(a[1]=t=>r(d).form.plan_unit=t),placeholder:"请输入"},null,8,["modelValue"])]),_:1}),o(g,{label:"复批时间",prop:"approval_time",class:"ww50 flex-sc"},{default:u(()=>[o(w,{modelValue:r(d).form.approval_time,"onUpdate:modelValue":a[2]||(a[2]=t=>r(d).form.approval_time=t),style:{width:"100%"},size:"large",type:"datetime",placeholder:"请选择",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD"},null,8,["modelValue"])]),_:1}),o(g,{label:"方案摘要",prop:"plan_abstract",class:"ww100 flex-sc"},{default:u(()=>[o(e,{size:"large",modelValue:r(d).form.plan_abstract,"onUpdate:modelValue":a[3]||(a[3]=t=>r(d).form.plan_abstract=t),type:"textarea",rows:4,placeholder:"请输入"},null,8,["modelValue"])]),_:1}),o(g,{label:"基础建设条件",prop:"condition",class:"ww100 flex-sc"},{default:u(()=>[o(e,{size:"large",modelValue:r(d).form.condition,"onUpdate:modelValue":a[4]||(a[4]=t=>r(d).form.condition=t),type:"textarea",rows:4,placeholder:"请输入"},null,8,["modelValue"])]),_:1}),o(g,{label:"实施方案文件上传",prop:"files2",class:"ww100 flex-ss"},{default:u(()=>[n("div",Ne,[r(d).form?.plan_attr?(F(),be(b,{key:0,files:r(d).form.plan_attr,"onUpdate:files":a[5]||(a[5]=t=>r(d).form.plan_attr=t),plans:U.plans,contents:U.contents,active:U.active},null,8,["files","plans","contents","active"])):O("",!0)])]),_:1})])]),_:1},8,["model","rules"]),n("div",Ue,[a[16]||(a[16]=n("div",{class:"flex-sc f18 plr10"},[n("span",null,"项目任务")],-1)),n("div",Te,[n("div",{class:Y(["mr40 pb10 f18 relative cursor actfont",r(v)==="key"?"i1 bob-i1-2":"bob-tt-2"]),onClick:a[6]||(a[6]=f(t=>M(v)?v.value="key":v="key",["stop"]))},[...a[13]||(a[13]=[n("span",null,"重点落实任务",-1)])],2),n("div",{class:Y(["mr40 pb10 f18 relative cursor actfont",r(v)==="check"?"i1 bob-i1-2":"bob-tt-2"]),onClick:a[7]||(a[7]=f(t=>M(v)?v.value="check":v="check",["stop"]))},[...a[14]||(a[14]=[n("span",null,"体检整改任务",-1)])],2)]),D(n("div",$e,[o(s,{"header-cell-class-name":"bgi16 c3","cell-style":{"background-color":"#FFFFFF",color:"#626366"},border:"","empty-text":"暂无数据",data:r(G),stripe:"",onSelectionChange:W},{default:u(()=>[o(p,{type:"selection",width:"60"}),o(p,{type:"index",label:"序号",align:"center",width:"60"}),o(p,{prop:"type",label:"体检类型",align:"center",width:"140"},{default:u(t=>[o(e,{modelValue:t.row.type,"onUpdate:modelValue":i=>t.row.type=i,size:"small"},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),o(p,{prop:"indicator",label:"指标项",align:"center",width:"200"},{default:u(t=>[o(e,{modelValue:t.row.indicator,"onUpdate:modelValue":i=>t.row.indicator=i,size:"small"},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),o(p,{prop:"problem",label:"存在问题"},{default:u(t=>[o(e,{modelValue:t.row.problem,"onUpdate:modelValue":i=>t.row.problem=i,size:"small"},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),o(p,{label:"操作",align:"center",width:"100"},{default:u(t=>[n("span",{class:"i1 cursor",onClick:f(i=>oe(t.row),["stop"])},"选择",8,ze)]),_:1}),o(p,{label:"内容",align:"center",width:"140"},{default:u(t=>[o(e,{modelValue:t.row.content,"onUpdate:modelValue":i=>t.row.content=i,size:"small"},null,8,["modelValue","onUpdate:modelValue"])]),_:1})]),_:1},8,["data"]),n("div",Ie,[n("span",{class:"i1 cursor",onClick:f(ee,["stop"])},"添加+")]),n("div",Ae,[n("div",Ee,[n("div",{class:"rad4 ptb5 plr15 cursor bo-c8-1 c8 mr10",onClick:f(te,["stop"])},"全选"),n("div",{class:"rad4 ptb5 plr15 cursor bgi13 i15 mr10",onClick:f(le,["stop"])},"删除"),n("div",{class:"rad4 ptb5 plr15 cursor bgi10 i12 mr10",onClick:f(ae,["stop"])},"导入")]),o(l,{layout:"prev, pager, next","page-count":5,"page-size":r(T).limit,"current-page":r(T).page,onCurrentChange:a[8]||(a[8]=t=>{r(T).page=t})},null,8,["page-size","current-page"])])],512),[[J,r(v)==="check"]]),D(n("div",Oe,[o(s,{"header-cell-class-name":"bgi16 c3","cell-style":{"background-color":"#FFFFFF",color:"#626366"},border:"","empty-text":"暂无数据",data:r(H),stripe:"",onSelectionChange:Q},{default:u(()=>[o(p,{type:"selection",width:"60"}),o(p,{type:"index",label:"序号",align:"center",width:"60"}),o(p,{prop:"task_type",label:"任务类型",align:"center",width:"140"},{default:u(t=>[o(e,{modelValue:t.row.task_type,"onUpdate:modelValue":i=>t.row.task_type=i,size:"small"},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),o(p,{prop:"construct_content",label:"建设内容"},{default:u(t=>[o(e,{modelValue:t.row.construct_content,"onUpdate:modelValue":i=>t.row.construct_content=i,size:"small"},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),o(p,{prop:"construct_scale",label:"建设规模",align:"center",width:"120"},{default:u(t=>[o(e,{modelValue:t.row.construct_scale,"onUpdate:modelValue":i=>t.row.construct_scale=i,size:"small"},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),o(p,{prop:"t2026",label:"2026年目标",align:"center",width:"120"},{default:u(t=>[o(e,{modelValue:t.row.t2026,"onUpdate:modelValue":i=>t.row.t2026=i,size:"small"},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),o(p,{prop:"t2027",label:"2027年目标",align:"center",width:"120"},{default:u(t=>[o(e,{modelValue:t.row.t2027,"onUpdate:modelValue":i=>t.row.t2027=i,size:"small"},null,8,["modelValue","onUpdate:modelValue"])]),_:1})]),_:1},8,["data"]),n("div",Re,[a[15]||(a[15]=n("div",null,null,-1)),n("div",{class:"i1 cursor",onClick:f(se,["stop"])},"添加年度")]),n("div",je,[n("div",Be,[n("div",{class:"rad4 ptb5 plr15 cursor bo-c8-1 c8 mr10",onClick:f(ne,["stop"])},"全选"),n("div",{class:"rad4 ptb5 plr15 cursor bgi13 i15 mr10",onClick:f(ie,["stop"])},"删除"),n("div",{class:"rad4 ptb5 plr15 cursor bgi10 i12 mr10",onClick:f(re,["stop"])},"导入")]),o(l,{layout:"prev, pager, next","page-count":5,"page-size":r($).limit,"current-page":r($).page,onCurrentChange:a[9]||(a[9]=t=>{r($).page=t})},null,8,["page-size","current-page"])])],512),[[J,r(v)==="key"]])]),n("div",Ye,[a[17]||(a[17]=n("div",{class:"flex-sc f18 plr10"},[n("span",null,"时序管理")],-1)),n("div",De,[o(s,{"header-cell-class-name":"bgi16 c3","cell-style":{"background-color":"#FFFFFF",color:"#626366"},border:"","empty-text":"暂无数据",data:C.value,stripe:""},{default:u(()=>[o(p,{type:"index",label:"序号",align:"center",width:"80"}),o(p,{prop:"year",label:"年度",align:"center",width:"120"}),o(p,{prop:"desc",label:"阶段任务描述"}),o(p,{prop:"investment",label:"阶段投资",align:"center",width:"140"}),o(p,{label:"操作",align:"center",width:"120"},{default:u(t=>[n("span",{class:"i1 cursor",onClick:f(i=>ce(t.row),["stop"])},"查看",8,Je)]),_:1})]),_:1},8,["data"])])]),n("div",Ke,[n("div",{class:"plr14 ptb5 rad4 ml15 cursor white bgi1 bo-i1-1",onClick:a[10]||(a[10]=f(t=>r(d).actIndex--,["stop"]))},"上一步"),r(d).title!="reserve"?(F(),E("div",{key:0,class:"plr14 ptb5 rad4 ml15 cursor white bgi1 bo-i1-1",onClick:a[11]||(a[11]=f(t=>q(r(j)),["stop"]))},"保 存")):O("",!0),r(d).title=="reserve"?(F(),E("div",{key:1,class:"plr14 ptb5 rad4 ml15 cursor white bgi1 bo-i1-1",onClick:a[12]||(a[12]=f(t=>r(d).actIndex++,["stop"]))},"下一步")):O("",!0)])])])}}}),it=ye(Me,[["__scopeId","data-v-317ceec8"]]);export{it as default};
