import{a5 as L,o as n,c as l,f as s,d as H,g as j,b as G,a3 as w,a as A,w as W,u as o,e as x,y as q,z as y,t as a,F as S,p as z,k as J,h as F,a6 as O,r as P,K as $,dj as Q,l as X}from"./index-Bd85TTIS.js";import{v as Y}from"./el-loading-QtaFgzrj.js";import{E as Z}from"./el-image-viewer-M0JIGJ1W.js";import{_ as tt}from"./AaTitle.vue_vue_type_script_setup_true_lang-DNddMUg2.js";import{F as M}from"./FileSaver.min-DM1dX5As.js";/* empty css                   */import{E}from"./index-DDNRsVXm.js";const st={viewBox:"0 0 1024 1024",width:"1.2em",height:"1.2em"};function et(v,c){return n(),l("svg",st,[...c[0]||(c[0]=[s("path",{fill:"currentColor",d:"M160 832h704a32 32 0 1 1 0 64H160a32 32 0 1 1 0-64m384-253.7L780.3 342l45.2 45.2L508.8 704L192 387.2l45.2-45.2L480 584.7V128h64z"},null,-1)])])}const ot=L({name:"ep-download",render:et}),it={viewBox:"0 0 1024 1024",width:"1.2em",height:"1.2em"};function nt(v,c){return n(),l("svg",it,[...c[0]||(c[0]=[s("path",{fill:"currentColor",d:"m512 747.8l228.2 120a6.4 6.4 0 0 0 9.2-6.7L706 607l184.5-180a6.4 6.4 0 0 0-3.5-10.8L632 379L517.7 147.9a6.4 6.4 0 0 0-11.6 0l-114 231.2L137 416a6.4 6.4 0 0 0-3.5 11L318 607l-43.6 254a6.4 6.4 0 0 0 9.3 6.8zM313.6 924.5a70.4 70.4 0 0 1-102.1-74.3l37.8-220.9L89 473a70.4 70.4 0 0 1 39-120.1l221.8-32.3l99.2-201a70.4 70.4 0 0 1 126.2 0l99.2 201L896.2 353a70.4 70.4 0 0 1 39 120L774.7 629.5l38 220.9a70.4 70.4 0 0 1-102.2 74.2L512 820.1z"},null,-1)])])}const at=L({name:"ep-star",render:nt}),rt={viewBox:"0 0 1024 1024",width:"1.2em",height:"1.2em"};function lt(v,c){return n(),l("svg",rt,[...c[0]||(c[0]=[s("path",{fill:"currentColor",d:"M313.6 924.5a70 70 0 0 1-74.2-5.4a70 70 0 0 1-28-68.9l38-220.9L89 473a70.4 70.4 0 0 1 3.7-104.3A70 70 0 0 1 128 353l221.8-32.3l99.2-201a70.4 70.4 0 0 1 100.2-28.5a70 70 0 0 1 26 28.6l99.2 201L896.2 353a70.4 70.4 0 0 1 39 120L774.7 629.5l38 220.9a70.4 70.4 0 0 1-102.2 74.2L512 820.1z"},null,-1)])])}const ct=L({name:"ep-star-filled",render:lt}),dt={class:"layout-col"},mt={class:"layout-row hh100 hidden"},_t={class:"kb-left layout-col"},pt={class:"bg-white rad8 p15 mb15"},ft={class:"flex-bc ww100 mb12"},ut={class:"flex-ec"},vt={class:"kb-meta table-col"},bt={class:"kb-meta-row flex-sc"},ht={class:"kb-meta-v line1"},kt={class:"kb-meta-row flex-sc"},gt={class:"kb-meta-v"},wt={class:"kb-meta-row flex-sc"},xt={class:"kb-meta-v"},yt={class:"kb-meta-row flex-sc"},$t={class:"kb-meta-v"},Lt={class:"kb-meta-row flex-sc"},Ct={class:"kb-meta-v"},Bt={class:"kb-meta-row flex-sc"},At={class:"kb-meta-v"},St={class:"bg-white rad8 p15 flex1 hidden"},zt={class:"kb-att table-col"},Ft={key:0,class:"i2 p10"},Mt={key:1},Et={class:"flex-sc flex1 hidden"},It={class:"kb-att-no"},Ut={class:"kb-att-name line1"},Nt={class:"kb-att-info"},Rt={class:"mr10"},Tt={class:"flex1 hh100 hidden ml15"},Vt={class:"bg-white rad8 p15 hh100 table-col"},Kt={class:"flex-bc ww100 mb10"},Dt={class:"fw f15"},Ht={key:0,class:"i2 p15"},jt={key:1},Gt={class:"kb-title tc fw mb10",style:{color:"#d84a4a"}},Wt={class:"kb-top-meta flex-cc i2 mb15"},qt={class:"mr25"},Jt=["innerHTML"],Ot={key:0,class:"kb-imgs mt15"},Pt={key:1,class:"kb-related mt15"},Qt={class:"kb-related-link"},Xt=H({__name:"detail",setup(v){const c=O(),I=Q(),{proxy:U}=j(),C=U.configStore(),e=P({id:"",item:{},loading:!1,error:""}),b=$(()=>String(C?.user?.id??C?.user??"").trim()||"anonymous"),f=$(()=>Array.isArray(e.item?.attachments)?e.item.attachments:[]),h=$(()=>{const i=e.item?.image_urls;return Array.isArray(i)?i.map(t=>String(t)).filter(t=>t.trim()):[]});G(async()=>{e.id=c.params.id||"",await N()});const N=async()=>{if(e.id){e.loading=!0,e.error="";try{const i=await w.kbItemApi({id:e.id,user_id:b.value}),t=i?.data?.item??i?.item??{};e.item=t||{},t||(e.error="未找到该文章")}catch{e.item={},e.error="加载失败，请稍后重试"}finally{e.loading=!1}}},R=async()=>{if(e.id)try{const i=await w.kbFavoriteToggleApi({user_id:b.value,item_id:e.id}),t=i?.data??i;e.item.is_favorited=!!t?.is_favorited,e.item.favorite_count=Number(t?.favorite_count??e.item.favorite_count??0)}catch{E({type:"error",message:"操作失败"})}},T=i=>{const t=String(i??"").trim();if(!t)return"";const _=String(import.meta?.env?.VITE_KB_URL??"").trim();return _&&t.startsWith("/kb-api/")?`${_}${t}`:t},V=async()=>{if(e.id)try{const i=await w.kbItemDownloadAllApi({user_id:b.value,item_id:e.id}),t=i?.data??i;e.item.download_count=Number(t?.download_count??e.item.download_count??0);const _=T(String(t?.download_url??""));if(_){const d=await fetch(_);if(!d.ok)throw new Error(`download failed: ${d.status}`);const u=await d.blob(),p=d.headers.get("content-disposition")||"",r=/filename\*=UTF-8''([^;]+)/i.exec(p),m=/filename="?([^"]+)"?/i.exec(p),D=decodeURIComponent((r?.[1]||m?.[1]||"").trim())||`attachments-${e.id}.zip`;M.saveAs(u,D);return}const k=f.value.map((d,u)=>{const p=String(d?.file_name??""),r=String(d?.file_type??"").toUpperCase()||"-",m=B(d?.file_size);return`${u+1}. ${p}  ${r}  ${m}`}),g=new Blob([k.join(`
`)||"no attachments"],{type:"text/plain;charset=utf-8"});M.saveAs(g,`attachments-${e.id}.txt`)}catch{E({type:"error",message:"下载失败"})}},B=i=>{const t=Number(i??0)||0;return t<1024?`${t} B`:t<1024*1024?`${(t/1024).toFixed(1)} KB`:t<1024*1024*1024?`${(t/1024/1024).toFixed(1)} MB`:`${(t/1024/1024/1024).toFixed(1)} GB`},K=()=>{I.back()};return(i,t)=>{const _=tt,k=ct,g=at,d=ot,u=Z,p=Y;return n(),l("div",dt,[A(_,{title:o(e).item.title||"文章详情"},{"right-content":W(()=>[s("div",{class:"rad4 ptb5 plr8 flex-cc cursor bgi1 white ml10",onClick:t[0]||(t[0]=x(r=>K(),["stop"]))},"返回")]),_:1},8,["title"]),s("div",mt,[s("div",_t,[s("div",pt,[s("div",ft,[t[5]||(t[5]=s("div",{class:"fw f15"},"文档信息",-1)),s("div",ut,[s("div",{class:q(["kb-act flex-cc cursor mr10",o(e).item.is_favorited?"kb-act-on":"kb-act-off"]),onClick:t[1]||(t[1]=x(r=>R(),["stop"]))},[o(e).item.is_favorited?(n(),y(k,{key:0,class:"f14 mr5"})):(n(),y(g,{key:1,class:"f14 mr5"})),t[3]||(t[3]=s("span",{class:"f13"},"收藏",-1))],2),s("div",{class:"kb-act kb-act-off flex-cc cursor",onClick:t[2]||(t[2]=x(r=>V(),["stop"]))},[A(d,{class:"f14 mr5"}),t[4]||(t[4]=s("span",{class:"f13"},"下载",-1))])])]),s("div",vt,[s("div",bt,[t[6]||(t[6]=s("span",{class:"kb-meta-k"},"文档名称",-1)),s("span",ht,a(o(e).item.title||"-"),1)]),s("div",kt,[t[7]||(t[7]=s("span",{class:"kb-meta-k"},"创建时间",-1)),s("span",gt,a(o(e).item.created_at||"-"),1)]),s("div",wt,[t[8]||(t[8]=s("span",{class:"kb-meta-k"},"修改时间",-1)),s("span",xt,a(o(e).item.updated_at||"-"),1)]),s("div",yt,[t[9]||(t[9]=s("span",{class:"kb-meta-k"},"作者",-1)),s("span",$t,a(o(e).item.author||"-"),1)]),s("div",Lt,[t[10]||(t[10]=s("span",{class:"kb-meta-k"},"下载次数",-1)),s("span",Ct,a(o(e).item.download_count??0),1)]),s("div",Bt,[t[11]||(t[11]=s("span",{class:"kb-meta-k"},"收藏次数",-1)),s("span",At,a(o(e).item.favorite_count??0),1)])])]),s("div",St,[t[12]||(t[12]=s("div",{class:"fw f15 mb12"},"附件列表",-1)),s("div",zt,[o(f).length===0?(n(),l("div",Ft,"暂无附件")):(n(),l("div",Mt,[(n(!0),l(S,null,z(o(f),(r,m)=>(n(),l("div",{key:r.id,class:"kb-att-row flex-bc"},[s("div",Et,[s("span",It,a(m+1)+".",1),s("span",Ut,a(r.file_name),1)]),s("div",Nt,[s("span",Rt,a((r.file_type||"").toUpperCase()||"-"),1),s("span",null,a(B(r.file_size)),1)])]))),128))]))])])]),s("div",Tt,[J((n(),l("div",Vt,[s("div",Kt,[s("div",Dt,a(o(e).item.column_name||o(e).item.column_code||"-"),1)]),o(e).error?(n(),l("div",Ht,a(o(e).error),1)):(n(),l("div",jt,[s("div",Gt,a(o(e).item.title||"-"),1),s("div",Wt,[s("span",qt,"时间："+a(o(e).item.publish_time||"-"),1),s("span",null,"来源："+a(o(e).item.publish_org||"-"),1)]),s("div",{class:"content",innerHTML:o(e).item.content||""},null,8,Jt),o(h).length?(n(),l("div",Ot,[(n(!0),l(S,null,z(o(h),(r,m)=>(n(),y(u,{key:`${m}-${r}`,src:r,"preview-src-list":o(h),"initial-index":m,fit:"contain",style:{width:"240px",height:"160px","border-radius":"6px","margin-right":"12px","margin-bottom":"12px"}},null,8,["src","preview-src-list","initial-index"]))),128))])):F("",!0),o(f).length?(n(),l("div",Pt,[t[13]||(t[13]=s("span",{class:"i2"},"相关附件：",-1)),s("span",Qt,a(o(f)[0]?.file_name),1)])):F("",!0)]))])),[[p,o(e).loading]])])])])}}}),ns=X(Xt,[["__scopeId","data-v-03b1d68f"]]);export{ns as default};
