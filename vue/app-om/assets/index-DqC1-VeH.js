import{d as Y,g as X,r as G,o as b,c as F,a as n,a6 as le,u as o,w as f,f as r,k as Z,x as H,e as S,t as z,h as J,i as j,l as K,a3 as ne,bf as ie,a8 as I,aa as re,b as ce,ad as de,B as pe,F as _e,q as ue,p as me,E as fe,ac as ge,a7 as Q}from"./index-BWjCSAnw.js";import{v as ee}from"./el-loading-CMa3kpEq.js";import{_ as te}from"./ViewFiles-BmDneZVF.js";import{E as ae,a as se}from"./el-table-column-Bxfuucky.js";import"./el-checkbox-DlSjzc6V.js";import{_ as be}from"./Problems-DN-uvPrB.js";import{E as he}from"./el-progress-DQWPeYlj.js";import{E as W}from"./el-message-CJx4xv24.js";import{_ as we}from"./AaTitle.vue_vue_type_script_setup_true_lang-Dok3GIN-.js";import{_ as ye}from"./filter-CFoa9Riw.js";const ve={class:"topclass"},ke={class:"ww100 h100x6 flex-col hidden"},$e={class:"layout-col white-rgba50 rad8 p15"},xe=["onClick"],Fe={key:1},Ce=["onClick"],Ne={key:1},Se=Y({__name:"ProblemLog",props:{state:{type:[Object,Array],default:()=>({})}},setup(q,{expose:u}){const{proxy:g}=X(),A=g.publicStore();g.configStore();let V=j();const l=G({...A.$state,status:""}),O=v=>parseInt(l.page)+v,E=async v=>{l.isFalse=!l.isFalse,l.isFalse&&(l.active={...v},t())},t=async v=>{let C={model:"t_scheme_problem_log",args:`scheme_id='${l.active.scheme_id}' and parent_id='${l.active.parent_id}'`};l.status!==""&&l.status!=null&&(C.args+=` and problem_status='${l.status}'`);let c={limit:l.limit,page:l.page},_={field:"COUNT(*)"},k={},m={};Object.assign(k,C,c),Object.assign(m,C,_);let $=await A.http({Api1:k,Api2:m});l.empty=!!g.isNull($.Api1),l.list=g.isNull($.Api1)?[]:$.Api1,l.total=g.isNull($.Api2)?0:$.Api2[0]["COUNT(*)"]};return u({onVisable:E}),(v,C)=>{const c=se,_=ae,k=te,m=le,$=ee;return b(),F("div",ve,[n(m,{"modal-class":"topclass",modelValue:o(l).isFalse,"onUpdate:modelValue":C[0]||(C[0]=x=>o(l).isFalse=x),title:"整改进度更新","before-close":E,draggable:!0,width:"62%"},{default:f(()=>[r("div",ke,[r("div",$e,[v.isNull(o(l).list)?J("",!0):Z((b(),H(_,{key:0,"header-cell-class-name":"bgi16 c3","cell-style":{"background-color":"#FFFFFF",color:"#626366"},border:"","empty-text":"暂无数据",data:o(l).list,stripe:""},{default:f(()=>[n(c,{type:"index",index:O,label:"序号",align:"center",width:"50"}),n(c,{prop:"msg",label:"修改内容"}),n(c,{prop:"action_rate",label:"原进度",width:"100",align:"center"}),n(c,{prop:"new_action_rate",label:"新进度",width:"100",align:"center"}),n(c,{label:"原支撑材料",align:"center",width:"100"},{default:f((x,R)=>[x.row.action_material?(b(),F("span",{key:0,class:"i1 cursor",onClick:S(L=>o(V).onVisable(x.row.action_material),["stop"])},"查看",8,xe)):(b(),F("span",Fe,"无"))]),_:1}),n(c,{label:"新支撑材料",align:"center",width:"100"},{default:f((x,R)=>[x.row.new_action_material?(b(),F("span",{key:0,class:"i1 cursor",onClick:S(L=>o(V).onVisable(x.row.new_action_material),["stop"])},"查看",8,Ce)):(b(),F("span",Ne,"无"))]),_:1}),n(c,{label:"更新时间",align:"center",width:"150"},{default:f((x,R)=>[r("span",null,z(v.parseTime(x.row.update_time)),1)]),_:1})]),_:1},8,["data"])),[[$,o(l).loading,void 0,{fullscreen:!0,lock:!0}]])])]),n(k,{ref_key:"viewRef",ref:V},null,512)]),_:1},8,["modelValue"])])}}}),Ae=K(Se,[["__scopeId","data-v-a0a5e390"]]),Ve={key:0},Ee={key:1},Oe=Y({__name:"UploadTextNoName",props:ie({action:{type:String,default:"/api/v1/terminal/base/uploadFile"},fileLimit:{type:Number,default:5},fileSize:{type:Number,default:50},fileType:{type:Array,default:[]},fileList:{type:[Array,String],default:[]}},{model:{},modelModifiers:{}}),emits:["update:model"],setup(q){const{proxy:u}=X();u.publicStore();const g=u.configStore(),A=ne(q,"model"),V=q,l=G({dialogVisible:!1,dialogImageUrl:""}),O=c=>{l.dialogImageUrl=c.url,l.dialogVisible=!0},E=c=>{const _=c.size/1024/1024<V.fileSize;return _||W({type:"error",message:"上传图片大小不能超过 "+V.fileSize+"MB!"}),_},t=(c,_,k)=>{let m=_.response.data;m&&Object.prototype.hasOwnProperty.call(_,"response")&&_.response.data&&(A.value=m,I({title:"提示",message:_.status=="success"?"上传成功":"上传失败",type:_.status=="success"?"success":"error"}))},v=(c,_)=>{if(!c||!Object.prototype.hasOwnProperty.call(c,"response"))return;let k=c.response.data,m=A.value.findIndex($=>$==k);m!=-1&&A.value.splice(m,1)},C=()=>{l.loading=!1,W({type:"error",message:"上传失败"})};return(c,_)=>{const k=he;return b(),H(k,{class:"avatar-uploader","show-file-list":!1,action:q.action,headers:{Authorization:o(g).token,"X-CSRF-Token":o(g).csrfToken,AuthToken:"xyz"+c.encrypt("xyz"+o(g).secret_key)},"before-upload":E,"on-success":t,"on-error":C,"on-remove":v,"on-preview":O},{default:f(()=>[A.value?(b(),F("span",Ve,"已上传")):(b(),F("span",Ee,"上传"))]),_:1},8,["action","headers"])}}}),Te=K(Oe,[["__scopeId","data-v-f57ee4de"]]),Ue={class:"layout-col"},Me={class:"flex-sc mr15"},Pe={class:"w50x6 flex-sc"},qe={class:"layout-col white-rgba50 rad8 p15"},Be={class:"ww100 flex-sc p8 mb15"},De={class:"flex-sc fw f16 tc"},Ie=["onClick"],Re={class:"mb5"},ze={class:"layout-col"},je=["onClick"],Le=["onClick"],Je={class:"ww100 flex-cc"},Ye=["onClick"],Xe=Y({__name:"index",setup(q){const{proxy:u}=X(),g=u.publicStore();u.configStore();const A=re(),V=[{value:"1",name:"限时整改",color:"i5"},{value:"2",name:"尽力整改",color:"i11"}];let l=j(),O=j(),E=j();const t=G({...g.$state}),v=s=>parseInt(t.page)+s,C=({row:s,column:e,rowIndex:p,columnIndex:i})=>{if(i===1||i===2)return p%2===0?{rowspan:2,colspan:1}:{rowspan:0,colspan:0}},c=({column:s})=>s.label==="整改进度"||s.label==="支撑材料上传"?{"background-color":"#FFFFFF",color:"#626366"}:{"background-color":"#F5F5F5",color:"#626366"};ce(async()=>{t.active={...A.query},await k(),m()});const _=s=>{const e=s.action_material;l.value.onVisable(e)},k=async()=>{let s={model:"t_task_type",args:`parent_id='${t.active.parent_id}'`,order:"orderd ASC"},e=await g.http({Api:s});t.actives=u.isNull(e)?[]:e.sort((p,i)=>p.orderd-i.orderd)},m=async s=>{let e={model:"t_task_problem",args:`parent_id='${t.active.id}'`,order:"orderd ASC"},p={model:"t_scheme_problem",args:`scheme_id='${t.active.scheme_id}' and parents_id='${t.active.id}'`};if(!u.isNull(t.datetime)){const[w,d]=t.datetime,h=new Date(w.getFullYear(),0,1).getTime()+"",B=new Date(d.getFullYear(),11,31,23,59,59,999).getTime()+"";p.args+=` and check_time>='${h}' and check_time<='${B}'`}let i=await g.http({Api1:e,Api2:p});t.task_problems=u.isNull(i.Api1)?[]:i.Api1,t.list=u.isNull(i.Api2)?[]:JSON.parse(JSON.stringify(i.Api2)),t.oldlist=u.isNull(i.Api2)?[]:JSON.parse(JSON.stringify(i.Api2))},$=async()=>{ge.confirm("是否确定保存?","温馨提示",{confirmButtonText:"确定",cancelButtonText:"关闭",type:"success"}).then(()=>{let s=L();if(console.log("params",s),u.isNull(s))return I({title:"提示",message:"无数据改变",type:"info"});let{forms:e,changeFile:p,logs:i}=oe(s),w={model:"t_scheme_problem",list:e};Q.updApi(w).then(d=>{d.code==200?(I({title:"提示",message:"操作成功",type:"success"}),m(),x(p),R(i)):I({title:"提示",message:d.msg?d.msg:"操作失败400",type:"error"})}).catch(d=>{I({title:"提示",message:"操作失败401",type:"error"})})})},x=async s=>{if(u.isNull(s))return console.log("无需转移");let e={list:s};g.http({changeFileApi:e}).then(p=>{console.log("转移res",p)})},R=async s=>{if(u.isNull(s))return;let e={model:"t_scheme_problem_log",list:s};Q.addApi(e).then(p=>{}).catch(p=>{})},L=()=>t.list.map((e,p)=>{const i=t.oldlist[p];if(!i)return null;const w=[];return e.action_rate!==i.action_rate&&w.push(`整改进度从原来${i.action_rate||"空"}到${e.action_rate||"空"}`),e.action_material!==i.action_material&&w.push("支撑材料已改变"),w.length===0?null:{id:e.id,scheme_id:t.active.scheme_id,parent_id:t.active.id,msg:w.join("，"),action_rate:i.action_rate,new_action_rate:e.action_rate,action_material:i.action_material,new_action_material:e.action_material,update_time:Date.now()+""}}).filter(Boolean),oe=s=>{const e=[],p=[],i=[],w="static/problems",d=Date.now()+"";return s.forEach((h,B)=>{const T=h.action_rate,D=h.action_material;let U=T,M=D;const P=[];h.new_action_rate!=null&&h.new_action_rate!==T&&(U=h.new_action_rate,P.push(`整改进度从原来${T||"空"}到${U||"空"}`));const a=h.new_action_material;if(a!=null&&a!==D){if(a.includes("/uploads")){const N="."+a.split(".").pop(),y=`${w}/${h.id}_${d}_${B}${N}`;i.push({oldfile:a,newfile:y}),M=y}else M=a;P.push("支撑材料已改变")}if(e.push({id:h.id,action_rate:U,action_material:M}),P.length>0){const{id:N,...y}=h;p.push({...y,msg:P.join("，"),action_rate:T,new_action_rate:U,action_material:D,new_action_material:M,update_time:d})}}),{forms:e,logs:p,changeFile:i}};return(s,e)=>{const p=pe,i=ye,w=we,d=se,h=fe,B=Te,T=ae,D=be,U=Ae,M=te,P=ee;return b(),F("div",Ue,[n(w,{title:""},{"left-content":f(()=>[r("div",Me,[e[5]||(e[5]=r("span",{class:"mr10"},"体检年度",-1)),r("span",Pe,[n(p,{class:"",style:{width:"100%"},modelValue:o(t).datetime,"onUpdate:modelValue":e[0]||(e[0]=a=>o(t).datetime=a),type:"yearrange","range-separator":"-","start-placeholder":"请选择年度","end-placeholder":"请选择年度"},null,8,["modelValue"])])]),r("div",{class:"rad4 ptb6 plr12 flex-cc cursor bgi1 white",onClick:e[1]||(e[1]=S(a=>m(),["stop"]))},[n(i,{class:"f12 fw"}),e[6]||(e[6]=r("span",{class:"f14 ml5"},"搜索",-1))])]),"right-content":f(()=>[r("div",{class:"rad4 ptb6 plr12 flex-cc cursor bo-i1-1 i1 ml15",onClick:e[2]||(e[2]=S(a=>o(E).onVisable({scheme_id:o(t).active.scheme_id,parent_id:o(t).active.id}),["stop"]))},[...e[7]||(e[7]=[r("span",{class:"f14 ml5"},"查看更新记录",-1)])]),r("div",{class:"rad4 ptb6 plr12 flex-cc cursor bo-i1-1 i1 ml15",onClick:e[3]||(e[3]=S(a=>$(),["stop"]))},[...e[8]||(e[8]=[r("span",{class:"f14 ml5"},"保存",-1)])]),r("div",{class:"rad4 ptb6 plr12 flex-cc cursor bo-i1-1 i1 ml15",onClick:e[4]||(e[4]=S(a=>o(de).back(),["stop"]))},[...e[9]||(e[9]=[r("span",{class:"f14 ml5"},"返回",-1)])])]),_:1}),r("div",qe,[r("div",Be,[r("div",De,[(b(!0),F(_e,null,ue(o(t).actives?o(t).actives:[],(a,N)=>(b(),F("div",{class:"mr20 cursor flex-col-cc",key:N,onClick:S(y=>{o(t).active.id=a.id,o(t).page=1,m()},["stop"])},[r("span",Re,z(a.name),1),r("span",{class:me(["ww100 h3 rad10",a.id==o(t).active.id?"bgi2":"black-rgba0"])},null,2)],8,Ie))),128))])]),r("div",ze,[s.isNull(o(t).list)?J("",!0):Z((b(),H(T,{key:0,"header-cell-class-name":"bgi16 c3","cell-style":c,"span-method":C,border:"","empty-text":"暂无数据",data:o(t).list,stripe:""},{default:f(()=>[n(d,{type:"index",index:v,label:"序号",align:"center",width:"50"}),n(d,{label:"指标项",width:"250"},{default:f((a,N)=>[r("span",null,z(a.row.parent_id?s.find(o(t).task_problems,["id",a.row.parent_id],"name"):""),1)]),_:1}),n(d,{prop:"result",label:"体检结果",align:"center",width:"80"}),n(d,{prop:"problem_content",label:"存在问题"}),n(d,{label:"整治类型",align:"center",width:"80"},{default:f((a,N)=>[r("span",null,z(a.row.action_type?s.find(V,["value",a.row.action_type],"name"):""),1)]),_:1}),n(d,{prop:"problem_num",label:"问题数量",width:"80",align:"center"}),n(d,{label:"整改进度",width:"100",align:"center"},{default:f((a,N)=>[n(h,{class:"i1 cursor progress-input",modelValue:a.row.action_rate,"onUpdate:modelValue":y=>a.row.action_rate=y,modelModifiers:{number:!0},placeholder:"请输入进度",type:"number",min:"0",max:"100",controls:!1,oninput:"if(value>100)value=100;if(value<0)value=0;if(value.indexOf('.')>=0)value=value.slice(0,value.indexOf('.')+3)"},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),n(d,{label:"问题区域",align:"center",width:"100"},{default:f((a,N)=>[r("span",{class:"i1 cursor",onClick:S(y=>o(O).onVisable(a.row),["stop"])},"查看问题分布",8,je)]),_:1}),n(d,{label:"整改项目清单",align:"center",width:"100"},{default:f((a,N)=>[r("span",{class:"i1 cursor",onClick:S(y=>s.toPath("/schemePlansManagerCity",{id:a.row.id}),["stop"])},"查看项目清单",8,Le)]),_:1}),n(d,{label:"支撑材料上传",width:"100",align:"center"},{default:f((a,N)=>[r("span",Je,[n(B,{model:a.row.action_material,"onUpdate:model":y=>a.row.action_material=y},null,8,["model","onUpdate:model"]),a.row.action_material?(b(),F("span",{key:0,class:"i1 cursor ml10",onClick:S(y=>_(a.row),["stop"])},"查看",8,Ye)):J("",!0)])]),_:1})]),_:1},8,["data"])),[[P,o(t).loading,void 0,{fullscreen:!0,lock:!0}]])])]),n(D,{state:o(t),ref_key:"problemRef",ref:O},null,8,["state"]),n(U,{state:o(t),ref_key:"problemlogRef",ref:E},null,8,["state"]),n(M,{ref_key:"viewRef",ref:l},null,512)])}}}),ot=K(Xe,[["__scopeId","data-v-a7b7d17d"]]);export{ot as default};
