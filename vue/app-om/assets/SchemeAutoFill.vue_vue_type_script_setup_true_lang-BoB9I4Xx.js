import{d as T,g as P,b,j as h,o as j,c as v,a4 as y}from"./index-ClTGGYJq.js";import{v as F}from"./v6-B4YtUg27.js";const f="__SCHEME_AUTOFILL_DEBUG__",E=T({__name:"SchemeAutoFill",props:{schemeId:{type:[String,Number],default:""},areaValue:{type:[String,Number],default:""},taskType:{type:[String,Number],default:""},draft:{type:Object,required:!0},schemePlans:{type:Array,default:()=>[]},schemeAreas:{type:Array,default:()=>[]}},setup(g){const e=g,{proxy:u}=P(),d=u.publicStore(),p=()=>{const a=globalThis;return a[f]||(a[f]={events:[],last:null,mountedCount:0}),a[f]},_=a=>{try{return JSON.parse(JSON.stringify(a))}catch{return a}},m=()=>{const a=e.draft||{},n=["parent_id","parent_area","task_type","estimate_year","estimated_start_time","estimated_end_time","plan_abstract","plan_unit","approval_time","condition","qu_stage_objective","name","num","code","construct_unit","construct_main","construct_price","construct_content","construct_note","completion_status","response_person","contact_person","contact_phone","vast_scheme","industrial_policy","gc_investmentd_irection","mapdata","total_put_price","total_completion_price","total_income_price","estimate_price","fund_source","orther_text"],t={};return n.forEach(s=>{t[s]=_(a[s])}),t},o=(a,n)=>{const t=p(),s={t:Date.now(),type:a,payload:_(n)};t.last=s,t.events.push(s),t.events.length>80&&t.events.splice(0,t.events.length-80)};o("moduleLoaded",{href:globalThis?.location?.href}),b(()=>{const a=p();a.mountedCount=(a.mountedCount||0)+1,o("mounted",{schemeId:e.schemeId,areaValue:e.areaValue,taskType:e.taskType,schemePlansLen:Array.isArray(e.schemePlans)?e.schemePlans.length:0,schemeAreasLen:Array.isArray(e.schemeAreas)?e.schemeAreas.length:0})});const A=a=>{if(!a)return;const n=m();if(console.log("[SchemeAutoFill] fillPlanInfo plan:",a),a.datetime)try{const t=typeof a.datetime=="string"?JSON.parse(a.datetime):a.datetime;console.log("[SchemeAutoFill] plan.datetime parsed:",t),Array.isArray(t)&&t.length===2&&(e.draft.estimate_year=t[0],e.draft.estimated_start_time=`${t[0]}-01-01`,e.draft.estimated_end_time=`${t[1]}-12-31`)}catch(t){console.log("[SchemeAutoFill] plan.datetime parse error:",t)}if(a.attr)try{const t=typeof a.attr=="string"?JSON.parse(a.attr):a.attr;if(console.log("[SchemeAutoFill] plan.attr parsed:",t),t.规划说明){const s=typeof t.规划说明=="string"?t.规划说明:t.规划说明?.name;s&&(e.draft.plan_abstract=s)}if(t.编制单位&&(e.draft.plan_unit=t.编制单位),t.批复时间&&(e.draft.approval_time=t.批复时间),t.基础建设条件&&(e.draft.condition=t.基础建设条件),t.规划目标){const s=typeof t.规划目标=="string"?t.规划目标:"";s&&(e.draft.qu_stage_objective=s)}}catch(t){console.log("[SchemeAutoFill] plan.attr parse error:",t)}o("fillPlanInfo.applied",{before:n,after:m(),plan:a})},k=async()=>{const a=e.schemeId,n=e.areaValue,t=e.taskType;if(o("fillProjectInfo.input",{schemeId:a,areaVal:n,taskType:t}),!a||!n||!t)return;const s=e.schemeAreas.find(r=>String(r.value??r.id)===String(n)),i=s?s.name:"";if(o("fillProjectInfo.areaResolved",{areaVal:n,areaObj:s,areaName:i}),!i)return;const l={model:"t_scheme_project",args:`scheme_id='${a}' AND aera='${i}' AND task_type='${t}'`};o("fillProjectInfo.query",l),console.log("[SchemeAutoFill] fillProjectInfo query:",l);const c=await d.http({Api:l});if(o("fillProjectInfo.result",c),console.log("[SchemeAutoFill] fillProjectInfo result:",c),!u.isNull(c)&&c.length>0){const r=c[0];console.log("[SchemeAutoFill] fillProjectInfo use first project:",r);const S=m();r.name&&(e.draft.name=r.name),r.num&&(e.draft.num=r.num),r.construct_price&&(e.draft.construct_price=r.construct_price),r.construct_datetime_start&&(e.draft.estimated_start_time=r.construct_datetime_start),r.construct_datetime_end&&(e.draft.estimated_end_time=r.construct_datetime_end),r.completion_status&&(e.draft.completion_status=r.completion_status),(r.province||r.city||r.district)&&(e.draft.area=[r.province||"",r.city||"",r.district||""]),o("fillProjectInfo.applied",{before:S,after:m(),project:r}),y({title:"提示",message:"已自动填充规划项目信息",type:"success"})}},I=async()=>{const a=e.schemeId;if(o("fillTaskInfo.input",{schemeId:a,taskType:e.taskType}),!a)return;let n=`scheme_id='${a}'`;e.taskType&&(n+=` AND task_type='${e.taskType}'`);const t={model:"t_scheme_task",args:n};o("fillTaskInfo.query",t),console.log("[SchemeAutoFill] fillTaskInfo query:",t);const s=await d.http({Api:t});if(o("fillTaskInfo.result",s),console.log("[SchemeAutoFill] fillTaskInfo result:",s),Array.isArray(s)&&s.length>0){const i=s.map(c=>({id:F(),task_type:c.task_type||e.taskType,task_class:c.task_class||"",construct_content:c.construct_content||"",year:"",value:c.unit_target||""}));Array.isArray(e.draft.task)||(e.draft.task=[]);const l=e.draft.task.filter(c=>String(c.task_type)!==String(e.taskType));e.draft.task=[...l,...i],y({title:"提示",message:`已自动填充 ${s.length} 条任务信息`,type:"success"})}};return h(()=>[e.schemeId,Array.isArray(e.schemePlans)?e.schemePlans.length:0],([a,n])=>{if(o("watch.schemeIdOrPlans",{val:a,schemePlansLen:n,schemeAreasLen:Array.isArray(e.schemeAreas)?e.schemeAreas.length:0}),!a)return;console.log("[SchemeAutoFill] schemeId changed:",a),console.log("[SchemeAutoFill] schemePlans:",e.schemePlans);const t=e.schemePlans.find(s=>String(s.id||s.value)===String(a));console.log("[SchemeAutoFill] matched plan:",t),t&&A(t),I()},{immediate:!0}),h(()=>[e.schemeId,e.areaValue,e.taskType],a=>{o("watch.schemeId/areaValue/taskType",a),console.log("[SchemeAutoFill] schemeId/areaValue/taskType changed:",a),k()},{immediate:!0}),(a,n)=>(j(),v("div"))}});export{E as _};
