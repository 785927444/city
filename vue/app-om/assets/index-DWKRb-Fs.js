import{l as z,b as E,j as P,o as _,c as C,f as w,d as W,g as B,r as U,a4 as p,a3 as V,ab as L,a as u,w as g,u as n,Z as R,i as T,$ as D,e as v,y as $,E as A,h as M,t as I,z as F}from"./index-CymMRwSV.js";const j={class:"s-canvas"},J=["width","height"],Q={__name:"Identify",props:{identifyCode:{type:String,default:"1234"},fontSizeMin:{type:Number,default:25},fontSizeMax:{type:Number,default:35},backgroundColorMin:{type:Number,default:255},backgroundColorMax:{type:Number,default:255},colorMin:{type:Number,default:0},colorMax:{type:Number,default:160},lineColorMin:{type:Number,default:40},lineColorMax:{type:Number,default:180},dotColorMin:{type:Number,default:0},dotColorMax:{type:Number,default:255},contentWidth:{type:Number,default:160},contentHeight:{type:Number,default:40}},setup(x){const t=x,i=(r,s)=>Math.floor(Math.random()*(s-r)+r),m=(r,s)=>{let f=i(r,s),c=i(r,s),y=i(r,s);return"rgb("+f+","+c+","+y+")"},k=r=>{for(let s=0;s<5;s++)r.strokeStyle=m(t.lineColorMin,t.lineColorMax),r.beginPath(),r.moveTo(i(0,t.contentWidth),i(0,t.contentHeight)),r.lineTo(i(0,t.contentWidth),i(0,t.contentHeight)),r.stroke()},e=(r,s,f)=>{r.fillStyle=m(t.colorMin,t.colorMax),r.font=i(t.fontSizeMin,t.fontSizeMax)+"px SimHei";let c=(f+1)*(t.contentWidth/(t.identifyCode.length+1)),y=i(t.fontSizeMax,t.contentHeight-5);var S=i(-45,45);r.translate(c,y),r.rotate(S*Math.PI/180),r.fillText(s,0,0),r.rotate(-S*Math.PI/180),r.translate(-c,-y)},N=r=>{for(let s=0;s<80;s++)r.fillStyle=m(0,255),r.beginPath(),r.arc(i(0,t.contentWidth),i(0,t.contentHeight),1,0,2*Math.PI),r.fill()},h=()=>{let s=document.getElementById("s-canvas").getContext("2d");s.textBaseline="bottom",s.fillStyle=m(t.backgroundColorMin,t.backgroundColorMax),s.fillRect(0,0,t.contentWidth,t.contentHeight);for(let f=0;f<t.identifyCode.length;f++)e(s,t.identifyCode[f],f);k(s),N(s)};return E(()=>{h()}),P(()=>t.identifyCode,()=>{h()}),(r,s)=>(_(),C("div",j,[w("canvas",{id:"s-canvas",ref:"element",width:t.contentWidth,height:t.contentHeight},null,8,J)]))}},Z=z(Q,[["__scopeId","data-v-62df1c1e"]]),G={class:"window loginbg"},K={class:"ww100 flex-sc f20 cb"},O={key:0,class:"ww100"},X={class:"flex-sc ww100"},Y={key:1,class:"w50x3 bgca white cursor rad5 tc ml15"},ee={key:1,class:"ww100"},te={class:"flex-sc ww100 hidden"},oe=["loading"],re=W({__name:"index",setup(x){const{proxy:t}=B(),i=t.publicStore(),m=t.configStore();let k=T();const e=U({...i.$state,tab:"username",ruleList_username:{username:[{required:!0,message:"请选择",trigger:["blur","change"]}],password:[{required:!0,message:"请输入",trigger:"blur"}]},ruleList_phone:{phone:[{required:!0,message:"请选择",trigger:["blur","change"]}],phonecode:[{required:!0,message:"请输入",trigger:"blur"}]},times:0,timesMark:""});E(async()=>{window.addEventListener("keydown",N),m.config&&!m.config.identifyCode&&e.tab=="username"&&r()});const N=async a=>{a.key=="Enter"&&y()};let h=!1;const r=async()=>{if(h)return;h=!0;let a=new Date().getTime()+"";i.http({codeApi:{time:a+""}}).then(o=>{h=!1,t.isNull(o)||(e.time=a,e.identifyCode=o)}).catch(o=>{h=!1,e.time="",e.identifyCode=""})};let s=!1;const f=async()=>{if(!s){if(!e.form.phone)return p({title:"提示",message:"请输入手机号码",type:"error"});if(!/^1[3-9]\d{9}$/.test(e.form.phone))return p({title:"提示",message:"请输入正确手机号码",type:"error"});s=!0,V.sendCodeApi({time:e.form.phone+""}).then(a=>a.code==200?(s=!1,e.times=60,e.timesMark&&clearInterval(e.timesMark),e.timesMark=setInterval(()=>{e.times>0?e.times--:clearInterval(e.timesMark)},1e3),p({title:"提示",message:a.msg,type:"success"})):(s=!1,e.times=0,p({title:"提示",message:a.msg,type:"error"}))).catch(a=>(s=!1,e.times=0,p({title:"提示",message:res.msg,type:"error"})))}};let c=!1;const y=()=>{k.value.validate(async a=>{if(a){if(e.tab=="username"&&e.identifyCode&&e.form.code!=e.identifyCode)return r(),p({title:"提示",message:"验证输入有误",type:"error"});S(),!c&&(c=!0,e.loading=!0,V.loginApi(e.query).then(o=>{if(c=!1,e.loading=!1,o.code==200){let l=o.data;if(!t.isNull(l)&&!t.isNull(l.user))m.$patch({token:l.token,user:l.user,distributId:l.user.station_num?l.user.station_num:m.distributId?m.distributId:"",password:"false"}),p({title:"提示",message:"登录成功",type:"success"}),t.toPath("/async");else return p({title:"提示",message:"获取用户信息失败",type:"error"})}else return p({title:"提示",message:o.msg,type:"error"})}).catch(o=>{c=!1,e.loading=!1,console.log("响应错误信息：",o)}))}}).catch(a=>{c=!1,e.loading=!1,console.log("表单错误信息：",a)})},S=()=>{if(e.tab=="username"){let a=e.form.username?t.encrypt(e.form.username.trim()):"",o=e.form.password?t.generateRandomString(5)+L.MD5([e.form.password].toString().trim()).toString().toUpperCase()+t.generateRandomString(5):"",l=e.form.code?e.form.code.trim():"";if(e.identifyCode){let b={code:l,time:e.time+""};e.query={model:"t_user",args:`username='${a}' and password='${o}'`,identify:b}}else e.query={model:"t_user",args:`username='${a}' and password='${o}'`}}if(e.tab=="phone"){let a=e.form.phone?t.encrypt(e.form.phone.trim()):"",l={code:e.form.phonecode?e.form.phonecode.trim():"",time:a};e.query={model:"t_user",args:`phone='${a}'`,identify:l}}};return(a,o)=>{const l=D,b=A,q=Z,H=R;return _(),C("div",G,[u(H,{class:"loginStyle absolute-cc ww28 rad5 plr50 pb40 pt40 white-rgba50",ref_key:"formRef",ref:k,model:n(e).form,rules:n(e)[`ruleList_${n(e).tab}`],"label-width":"85px",size:"large","status-icon":""},{default:g(()=>[u(l,{label:"",prop:""},{default:g(()=>[w("div",K,[w("div",{class:$(["flex-sc pr20 cursor",n(e).tab=="phone"?"":"i1"]),onClick:o[0]||(o[0]=v(d=>{n(e).tab="username",r()},["stop"]))},"账密登录",2),w("div",{class:$(["flex-sc pr20 cursor",n(e).tab=="phone"?"i1":""]),onClick:o[1]||(o[1]=v(d=>n(e).tab="phone",["stop"]))},"手机登录",2)])]),_:1}),n(e).tab=="phone"?(_(),C("div",O,[u(l,{label:"手机号",prop:"phone"},{default:g(()=>[u(b,{size:"large",modelValue:n(e).form.phone,"onUpdate:modelValue":o[2]||(o[2]=d=>n(e).form.phone=d),placeholder:"手机号",maxlength:"11"},null,8,["modelValue"])]),_:1}),u(l,{label:"验证码",prop:"phonecode"},{default:g(()=>[w("div",X,[u(b,{size:"large",modelValue:n(e).form.phonecode,"onUpdate:modelValue":o[3]||(o[3]=d=>n(e).form.phonecode=d),placeholder:"短信验证",autocomplete:"off"},null,8,["modelValue"]),n(e).times?M("",!0):(_(),C("div",{key:0,class:"w50x3 bgi1 white cursor rad5 tc ml15",onClick:o[4]||(o[4]=v(d=>f(),["stop"]))},"发送验证码")),n(e).times?(_(),C("div",Y,I(n(e).times+"s"),1)):M("",!0)])]),_:1})])):M("",!0),n(e).tab=="username"?(_(),C("div",ee,[u(l,{label:"账号",prop:"username"},{default:g(()=>[u(b,{size:"large",modelValue:n(e).form.username,"onUpdate:modelValue":o[5]||(o[5]=d=>n(e).form.username=d),placeholder:"登录账号"},null,8,["modelValue"])]),_:1}),u(l,{label:"密码",prop:"password"},{default:g(()=>[u(b,{size:"large",modelValue:n(e).form.password,"onUpdate:modelValue":o[6]||(o[6]=d=>n(e).form.password=d),placeholder:"登录密码",type:"password","show-password":""},null,8,["modelValue"])]),_:1}),n(e).identifyCode?(_(),F(l,{key:0,prop:"code",label:"验证",rules:[{required:!0,message:"图片验证必须",trigger:"blur"}]},{default:g(()=>[w("div",te,[u(b,{size:"large",modelValue:n(e).form.code,"onUpdate:modelValue":o[7]||(o[7]=d=>n(e).form.code=d),placeholder:"请输入验证",autocomplete:"off"},null,8,["modelValue"]),u(q,{class:"ml15",identifyCode:n(e).identifyCode,onClick:o[8]||(o[8]=v(d=>r(),["stop"]))},null,8,["identifyCode"])])]),_:1})):M("",!0)])):M("",!0),u(l,{label:"",prop:""},{default:g(()=>[w("div",{class:"ww100 bgi1 white cursor rad5 p5 tc f18 mt15",onClick:o[9]||(o[9]=v(d=>y(),["stop"])),loading:n(e).loading},I(n(e).loading?"登录中":"登 录"),9,oe)]),_:1})]),_:1},8,["model","rules"])])}}}),ne=z(re,[["__scopeId","data-v-39d8a161"]]);export{ne as default};
