import{d as v,g as q,r as F,b as M,o as I,c as b,u as k,e as A,h as j,aa as G,a4 as x,a9 as H,a3 as K}from"./index-CymMRwSV.js";const L=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i;function X(e){return typeof e=="string"&&L.test(e)}function z(e){if(!X(e))throw TypeError("Invalid UUID");let t;return Uint8Array.of((t=parseInt(e.slice(0,8),16))>>>24,t>>>16&255,t>>>8&255,t&255,(t=parseInt(e.slice(9,13),16))>>>8,t&255,(t=parseInt(e.slice(14,18),16))>>>8,t&255,(t=parseInt(e.slice(19,23),16))>>>8,t&255,(t=parseInt(e.slice(24,36),16))/1099511627776&255,t/4294967296&255,t>>>24&255,t>>>16&255,t>>>8&255,t&255)}const o=[];for(let e=0;e<256;++e)o.push((e+256).toString(16).slice(1));function O(e,t=0){return(o[e[t+0]]+o[e[t+1]]+o[e[t+2]]+o[e[t+3]]+"-"+o[e[t+4]]+o[e[t+5]]+"-"+o[e[t+6]]+o[e[t+7]]+"-"+o[e[t+8]]+o[e[t+9]]+"-"+o[e[t+10]]+o[e[t+11]]+o[e[t+12]]+o[e[t+13]]+o[e[t+14]]+o[e[t+15]]).toLowerCase()}let E;const Q=new Uint8Array(16);function U(){if(!E){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");E=crypto.getRandomValues.bind(crypto)}return E(Q)}const S={};function W(e,t,r){let n;const c=e?._v6??!1;if(e){const s=Object.keys(e);s.length===1&&s[0]==="_v6"&&(e=void 0)}if(e)n=V(e.random??e.rng?.()??U(),e.msecs,e.nsecs,e.clockseq,e.node,t,r);else{const s=Date.now(),a=U();Y(S,s,a),n=V(a,S.msecs,S.nsecs,c?void 0:S.clockseq,c?void 0:S.node,t,r)}return t??O(n)}function Y(e,t,r){return e.msecs??=-1/0,e.nsecs??=0,t===e.msecs?(e.nsecs++,e.nsecs>=1e4&&(e.node=void 0,e.nsecs=0)):t>e.msecs?e.nsecs=0:t<e.msecs&&(e.node=void 0),e.node||(e.node=r.slice(10,16),e.node[0]|=1,e.clockseq=(r[8]<<8|r[9])&16383),e.msecs=t,e}function V(e,t,r,n,c,s,a=0){if(e.length<16)throw new Error("Random bytes length must be >= 16");if(!s)s=new Uint8Array(16),a=0;else if(a<0||a+16>s.length)throw new RangeError(`UUID byte range ${a}:${a+15} is out of buffer bounds`);t??=Date.now(),r??=0,n??=(e[8]<<8|e[9])&16383,c??=e.slice(10,16),t+=122192928e5;const _=((t&268435455)*1e4+r)%4294967296;s[a++]=_>>>24&255,s[a++]=_>>>16&255,s[a++]=_>>>8&255,s[a++]=_&255;const y=t/4294967296*1e4&268435455;s[a++]=y>>>8&255,s[a++]=y&255,s[a++]=y>>>24&15|16,s[a++]=y>>>16&255,s[a++]=n>>>8|128,s[a++]=n&255;for(let N=0;N<6;++N)s[a++]=c[N];return s}function Z(e){const t=typeof e=="string"?z(e):e,r=P(t);return typeof e=="string"?O(r):r}function P(e){return Uint8Array.of((e[6]&15)<<4|e[7]>>4&15,(e[7]&15)<<4|(e[4]&240)>>4,(e[4]&15)<<4|(e[5]&240)>>4,(e[5]&15)<<4|(e[0]&240)>>4,(e[0]&15)<<4|(e[1]&240)>>4,(e[1]&15)<<4|(e[2]&240)>>4,96|e[2]&15,e[3],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15])}function B(e,t,r){e??={};let n=W({...e,_v6:!0},new Uint8Array(16));return n=Z(n),O(n)}const ee={class:"ww100 flex-cc f18 p40"},ie=v({__name:"StepFoot",props:{state:{type:[Object,Array],default:()=>({})}},emits:["init"],setup(e,{emit:t}){const{proxy:r}=q(),n=r.publicStore(),c=r.configStore();F({...n.$state,type:"plan"});const s=e,a=t;M(async()=>{});const _=()=>{if(n.actIndex==1)return G.back();n.actIndex--},y=()=>{if(s.state.type=="plan"&&n.actIndex==1){if(!n.form.name)return x({title:"提示",message:"请输入规划名称",type:"error"});if(!n.form.datetime)return x({title:"提示",message:"请选择规划周期",type:"error"})}if(s.state.type=="design"&&n.actIndex==1){if(!n.form.name)return x({title:"提示",message:"请输入片区名称",type:"error"});if(!n.form.num)return x({title:"提示",message:"请输入片区编号",type:"error"});if(!n.form.parent_id)return x({title:"提示",message:"请选择专项规划",type:"error"});if(!n.form.parent_area)return x({title:"提示",message:"请选择专项片区",type:"error"})}n.actIndex++},N=async()=>{H.confirm("保存信息后可进行上报，是否确定继续","温馨提示",{confirmButtonText:"确定",cancelButtonText:"关闭",type:"warn"}).then(()=>{let i=JSON.parse(JSON.stringify(n.form)),f=i.id?"updApi":"addApi";i.id||(i.id=B());let d=[];r.isNull(i.attr)?i.attr="":(Object.keys(i.attr).forEach(l=>{if(i.attr[l].data&&i.attr[l].data.indexOf("/uploads")!=-1){let w=n._public.contents.find(T=>T.type==l);const D="."+n.form.attr[l].data.split(".").pop(),$=`${w.parent_type}/${c.user.id}_${l}${D}`;i.attr[l].data=$,d.push({oldfile:n.form.attr[l].data,newfile:$})}}),i.attr=JSON.stringify(i.attr));let m=[],p=[];JSON.stringify(i.project)!=JSON.stringify(n._public.project)&&(m=i.project.filter(l=>!l.id),p=n._public.project.filter(l=>!i.project.some(w=>w.id===l.id)));let g=[],h=[];JSON.stringify(i.task)!=JSON.stringify(n._public.task)&&(g=i.task.filter(l=>!l.id),h=n._public.task.filter(l=>!i.task.some(w=>w.id===l.id))),i.type=s.state.type,i.examine_status="0",i.datetime=r.isNull(i.datetime)?"":JSON.stringify(i.datetime),i.project_num=i.project.length,i.task_num=i.task.length,i.user_id=c.user.id,i.user_name=c.user.name,i.province=c.user.province?c.user.province:"",i.city=c.user.city?c.user.city:"",i.district=c.user.district?c.user.district:"",i.province_name=c.user.province_name?c.user.province_name:"",i.city_name=c.user.city_name?c.user.city_name:"",i.district_name=c.user.district_name?c.user.district_name:"";let u={model:"t_scheme_plan",list:[i]};K[f](u).then(async l=>{l.code==200?(x({title:"提示",message:"保存成功",type:"success"}),C(d),(!r.isNull(m)||!r.isNull(p)||!r.isNull(g)||!r.isNull(h))&&((!r.isNull(m)||!r.isNull(g))&&await J(m,g,i.id),(!r.isNull(p)||!r.isNull(h))&&await R(p,h,i.id)),a("init",i.id)):x({title:"提示",message:l.msg?l.msg:"保存失败(400)",type:"error"})}).catch(l=>{x({title:"提示",message:"保存失败(500)",type:"error"})})})},C=async i=>{if(r.isNull(i))return console.log("无需转移");let f={list:i};n.http({changeFileApi:f}).then(d=>{console.log("转移res",d)})},J=async(i,f,d)=>{let m={model:"t_scheme_plan",args:`id='${d}'`},p=await n.http({Api:m});if(r.isNull(p))return;i.forEach(u=>{u.id="",u.scheme_id=p[0].id,u.scheme_name=p[0].name}),f.forEach(u=>{u.id="",u.scheme_id=p[0].id,u.scheme_name=p[0].name});let g={};r.isNull(i)||(g.addApi={model:"t_scheme_project",list:i}),r.isNull(f)||(g.addApi1={model:"t_scheme_task",list:f});let h=await n.http(g);console.log("新增res---",h)},R=async(i,f,d)=>{let m={};r.isNull(i)||(m.delApi={model:"t_scheme_project",list:i}),r.isNull(f)||(m.delApi1={model:"t_scheme_task",list:f});let p=await n.http(m);console.log("删除res---",p)};return(i,f)=>(I(),b("div",ee,[k(n).actIndex!=1?(I(),b("div",{key:0,class:"plr14 ptb5 rad4 mr15 cursor c9 bg-white bo-c9-1",onClick:f[0]||(f[0]=A(d=>_(),["stop"]))},"上一步")):j("",!0),k(n).actIndex==1?(I(),b("div",{key:1,class:"plr14 ptb5 rad4 ml15 cursor white bgi1 bo-i1-1",onClick:f[1]||(f[1]=A(d=>y(),["stop"]))},"下一步")):j("",!0),k(n).actIndex==2?(I(),b("div",{key:2,class:"plr14 ptb5 rad4 ml15 cursor white bgi1 bo-i1-1",onClick:f[2]||(f[2]=A(d=>N(),["stop"]))},"保存")):j("",!0)]))}});export{ie as _};
